<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Private Comms – Stable Build</title>
  <style>
    body {
      margin: 0;
      font-family: monospace;
      background: #0b0b0b;
      color: #eaeaea;
      height: 100vh;
      display: flex;
    }
    #tasks, #files {
      width: 20%;
      padding: 10px;
      background: #111;
      overflow-y: auto;
    }
    #chat {
      width: 60%;
      display: flex;
      flex-direction: column;
      border-left: 1px solid #222;
      border-right: 1px solid #222;
    }
    h3 {
      margin: 0 0 10px 0;
      text-align: center;
      color: #7cf;
    }
    #log {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #000;
    }
    #input {
      display: flex;
      gap: 5px;
      border-top: 1px solid #222;
      padding: 5px;
    }
    input, button {
      background: #111;
      color: #fff;
      border: 1px solid #333;
      padding: 8px;
      font-family: monospace;
    }
    input { flex: 1; }
    button { cursor: pointer; }
    .task {
      display: flex;
      justify-content: space-between;
      background: #000;
      padding: 5px;
      margin-bottom: 5px;
    }
    .task button { color: red; }
    a { color: #7cf; text-decoration: none; }
  </style>
</head>
<body>

  <div id="tasks">
    <h3>Tasks</h3>
    <input id="taskInput" placeholder="new task" />
    <button onclick="addTask()">add</button>
    <div id="tasksList"></div>
  </div>

  <div id="chat">
    <h3>Shared Channel</h3>
    <div id="log"></div>
    <div id="input">
      <input id="msg" placeholder="type message..." />
      <button onclick="sendMsg()">send</button>
    </div>
  </div>

  <div id="files">
    <h3>Files</h3>
    <input type="file" id="file" />
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getDatabase,
  ref,
  push,
  remove,
  onChildAdded,
  get
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

/* ===== FIREBASE CONFIG ===== */
const firebaseConfig = {

  apiKey: "AIzaSyBUWx-tyhewHl2LDVVhZlBB3REe2ypaJXw",

  authDomain: "comms-box.firebaseapp.com",

  databaseURL: "https://comms-box-default-rtdb.firebaseio.com",

  projectId: "comms-box",

  storageBucket: "comms-box.firebasestorage.app",

  messagingSenderId: "1041346884610",

  appId: "1:1041346884610:web:2984c9ee76c3cf8208e31b"

};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const user = prompt("name?") || "anon";

const log = document.getElementById("log");
const msg = document.getElementById("msg");
const file = document.getElementById("file");
const taskInput = document.getElementById("taskInput");
const tasksList = document.getElementById("tasksList");

const chatRef = ref(db, "channel");
const taskRef = ref(db, "tasks");

/* ===== RENDER MESSAGE ===== */
function renderMessage(d) {
  if (d.type === "msg") {
    log.innerHTML += `<div><b>${d.u}:</b> ${d.text}</div>`;
  }
  if (d.type === "file") {
    log.innerHTML += `<div><b>${d.u}:</b> <a href="${d.data}" download="${d.name}">${d.name}</a></div>`;
  }
}

/* ===== LOAD CHAT HISTORY ONCE ===== */
get(chatRef).then(snapshot => {
  if (!snapshot.exists()) return;
  snapshot.forEach(child => renderMessage(child.val()));
  log.scrollTop = log.scrollHeight;
});

/* ===== LIVE CHAT UPDATES ===== */
onChildAdded(chatRef, snap => {
  renderMessage(snap.val());
  log.scrollTop = log.scrollHeight;
});

/* ===== SEND MESSAGE ===== */
window.sendMsg = () => {
  if (!msg.value.trim()) return;
  push(chatRef, {
    type: "msg",
    u: user,
    text: msg.value,
    t: Date.now()
  });
  msg.value = "";
};

msg.addEventListener("keydown", e => {
  if (e.key === "Enter") sendMsg();
});

/* ===== FILE SHARE ===== */
file.addEventListener("change", () => {
  const f = file.files[0];
  if (!f) return;
  const r = new FileReader();
  r.onload = () => {
    push(chatRef, {
      type: "file",
      u: user,
      name: f.name,
      data: r.result,
      t: Date.now()
    });
    file.value = "";
  };
  r.readAsDataURL(f);
});

/* ===== TASKS ===== */
window.addTask = () => {
  if (!taskInput.value.trim()) return;
  push(taskRef, {
    text: taskInput.value,
    by: user,
    t: Date.now()
  });
  taskInput.value = "";
};

get(taskRef).then(snapshot => {
  if (!snapshot.exists()) return;
  snapshot.forEach(child => renderTask(child.key, child.val()));
});

onChildAdded(taskRef, snap => renderTask(snap.key, snap.val()));

function renderTask(key, d) {
  if (document.getElementById(key)) return;
  const div = document.createElement("div");
  div.className = "task";
  div.id = key;
  div.innerHTML = `<span>${d.text}</span><button>✖</button>`;
  div.querySelector("button").onclick = () => remove(ref(db, "tasks/" + key));
  tasksList.appendChild(div);
}
</script>

</body>
</html>

